
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-9.1.6">
    
    
      
        <title>Task 7 - Day 2 operation using GitLab CICD Pipeline - Cisco Live 2023 LTRDCN-2765</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.ded33207.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.a0c5b2b5.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent="">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#task-7-day-2-operation-using-gitlab-cicd-pipeline" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Cisco Live 2023 LTRDCN-2765" class="md-header__button md-logo" aria-label="Cisco Live 2023 LTRDCN-2765" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Cisco Live 2023 LTRDCN-2765
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Task 7 - Day 2 operation using GitLab CICD Pipeline
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/ciscolivelab/LTRDCN-2765" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href=".." class="md-tabs__link">
        Home
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../Guide-lab_topology/" class="md-tabs__link">
        Lab Overview
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../task1-VPN/" class="md-tabs__link">
        Lab Guide
      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Cisco Live 2023 LTRDCN-2765" class="md-nav__button md-logo" aria-label="Cisco Live 2023 LTRDCN-2765" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Cisco Live 2023 LTRDCN-2765
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/ciscolivelab/LTRDCN-2765" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1" >
      
      
        
          
            
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="..">Home</a>
          
        </div>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_1">
          <span class="md-nav__icon md-icon"></span>
          Home
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
      
      
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
          Lab Overview
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Lab Overview
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Guide-lab_topology/" class="md-nav__link">
        Lab Topology
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Guide-lab_access/" class="md-nav__link">
        Lab Devices Access
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../intro/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
          Lab Guide
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Lab Guide
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../task1-VPN/" class="md-nav__link">
        Task 1 - VPN connection
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../task2-ansible-node/" class="md-nav__link">
        Task 2 - Ansible installation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../task3-first-ansible/" class="md-nav__link">
        Task 3 - First Ansible Playbook
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../task4-vxlan-jinja2-new/" class="md-nav__link">
        Task 4 - Use Jinja2 templates with Ansible
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../task5-vxlan-nxos/" class="md-nav__link">
        Task 5 - Config switches using Ansible NXOS modules
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../task6-day2-pipeline.md" class="md-nav__link">
        Task 6 - Day 2 Opertions with CI Pipeline
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#step-1-playbook-to-verify-underlay-and-overlay" class="md-nav__link">
    Step 1: Playbook to verify underlay and overlay
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-2-install-git-and-gitlab-runner" class="md-nav__link">
    Step 2: Install git and GitLab runner
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-3-gitlab-repository-setup" class="md-nav__link">
    Step 3: GitLab repository setup
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-4-add-cicd-pipeline-file" class="md-nav__link">
    Step 4: Add CI/CD pipeline file
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-5-register-local-gitlab-runner" class="md-nav__link">
    Step 5: Register local gitlab-runner
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-6-add-new-vnis-in-staging-and-trigger-pipeline" class="md-nav__link">
    Step 6: Add new VNIs in Staging and trigger pipeline
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-7-review-pipeline-testing-and-staging-results" class="md-nav__link">
    Step 7: Review pipeline testing and staging results
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-8-merge-code-to-main-branch" class="md-nav__link">
    Step 8: Merge code to main branch
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="task-7-day-2-operation-using-gitlab-cicd-pipeline">Task 7 - Day 2 operation using GitLab CICD Pipeline</h1>
<p>We will implement CI/CD pipeline for day 2 operation tasks in this section.  GitLab and GitLab runner will be used for this purpose</p>
<ul>
<li>GitLab is software development platform that incorporates multiple capabilities including Version Control, code review and CI/CD in single system. </li>
<li>The cloud hosted GitLab (SaaS) is used in this lab.  VCS and CI/CD capabilities of GitLab will be used in this lab. </li>
<li>To execute tasks in a private network (i.e. behind Firewall, private infrastructure), GitLab Runner is used.  </li>
<li>GitLab Runner is an application that run tests &amp; results i.e., jobs in a pipeline and then send the results to GitLab.  GitLab runner will be installed on the same local server as Ansible host in this lab setup.</li>
</ul>
<p>As a Version Control System (VCS), a Git repository will created on the GitLab (SaaS).  All the code (Ansible playbooks, roles etc.) will be saved on this repository.  The centralized &amp; Cloud hosted (SaaS) VCS provided by GitLab allows to maintain version control, track changes of files, collaboration among many engineers etc.  In this lab, the CI/CD component of GitLab will be integrated with VCS, so that changes made on repository can automatically trigger execution of job via a pipeline file.</p>
<p>The process for creating a CI/CD pipeline with GitLab &amp; GitLab runner include below procedure:</p>
<ul>
<li>Create a project in GitLab.</li>
<li>Install and register the GitLab Runner for your project.</li>
<li>Define a CI/CD job (steps, tests) in a file named <code>.gitlab-ci.yml</code> in the root of the repository.</li>
<li>Conditions/rules can be defined in <code>.gitlab-ci.yml</code> file (YAML syntax) that will perform a job and display the results in GitLab pipeline e.g. When a commit to repository is done then the runner may execute the job and display the results in GitLab pipeline.</li>
</ul>
<p>In this section, CI/CD pipeline for day 2 operation tasks will be implemented.  Below steps will be performed:</p>
<ul>
<li>Create an Ansible playbook to verify underlay and overlay</li>
<li>Version control for the EVPN Ansible playbooks using GitLab version control capabilities</li>
<li>Create CI pipeline using GitLab</li>
<li>Add new VNIs into existing fabric</li>
<li>Verify CI pipeline in test and staging stages</li>
<li>Commit the merger and verify CI Pipeline in production stage</li>
</ul>
<p>Below picture gives an overview of the overall activities for this task i.e., multiple environments (testing, staging, production), CICD Pipeline using GitLab and Version Control System (VCS) capabilities using GitLab.</p>
<p><img alt="" src="../pic/5-0-1.png" /></p>
<hr />
<h3 id="step-1-playbook-to-verify-underlay-and-overlay">Step 1: Playbook to verify underlay and overlay</h3>
<p>In this step, you will create the playbook to verify underlay and overlay operation. The playbook will be applied to all leaf switches to verify the below commands:</p>
<p><strong><em>Underlay</em></strong></p>
<pre><code>-   show ip ospf neighbor
-   show ip bgp sum
-   show ip pim neighbor
</code></pre>
<p><strong><em>Overlay</em></strong></p>
<pre><code>-   show nve vni
-   show nve peer
-   show ip route vrf Tenant-1
-   show bgp l2vpn evpn
-   show l2route evpn mac-ip all
</code></pre>
<ul>
<li>Switch to <strong>Atom</strong>.  On the left page <strong>right click</strong> on the folder <code>EVPN-Ansible</code> and create a new playbook named <code>verify_fabric.yml</code>.   Enter this file name and hit <strong>enter</strong>.  Then <strong>Copy</strong> and <strong>Paste</strong> the below content to this newly created file:</li>
</ul>
<pre><code class="language-YAML">---
  - hosts: leaf, jinja2_leaf
    connection: local
    gather_facts: false
    tasks:
      - name: verify underlay
        register: underlay_output
        cisco.nxos.nxos_command:
          commands:
            - show ip ospf neighbors
            - show ip bgp sum
            - show ip pim neighbor
        tags: underlay
      - debug: var=underlay_output.stdout_lines
        tags: underlay
      - set_fact:
          savefile: &quot;{{underlay_output.stdout_lines | to_nice_yaml}}&quot;
      - local_action: copy content=&quot;{{savefile}}&quot; dest=./underlay.txt
      - name: Verify Overlay
        register: overlay_output
        cisco.nxos.nxos_command:
          commands:
            - show nve vni
            - show nve peer
            - show ip route vrf Tenant-1
            - show bgp l2vpn evpn
            - show l2route evpn mac-ip all
        tags: overlay
      - debug: var=overlay_output.stdout_lines
        tags: overlay
      - set_fact:
          savefile: &quot;{{overlay_output.stdout_lines | to_nice_yaml}}&quot;
      - local_action: copy content=&quot;{{savefile}}&quot; dest=./overlay.txt
</code></pre>
<ul>
<li>
<p><strong>Click</strong> <code>File</code> and <code>Save</code> on <strong>Atom</strong>. This will save the playbook, and also scp the playbook to Ansible server using pre-configured “<strong>remote-sync</strong>” package.</p>
</li>
<li>
<p>On the <strong>Ansible</strong> node (via <strong>MTPuTTy</strong>), run <strong>verify_fabric.yml</strong> playbook and verify the output for <strong>underlay</strong> by executing below command (using respective tag).  This command will show ospf, bgp and pim neighbors for all leaf switches:</p>
</li>
</ul>
<pre><code>cd ~/EVPN-Ansible
ansible-playbook verify_fabric.yml --tags &quot;underlay&quot;
</code></pre>
<ul>
<li>
<p>Below screenshot shows the partial output of above command and shows ospf, bgp and pim neighbors for all leaf switches:</p>
<p><img alt="" src="../pic/5-2-1.png" /></p>
</li>
</ul>
<p>Here is complete log of execution of above playbook/command:</p>
<pre><code>root@ubuntu:~/EVPN-Ansible# ansible-playbook verify_fabric.yml --tags &quot;underlay&quot;

PLAY [leaf, jinja2_leaf] *********************************************************************************************************************************************************************************************

TASK [verify underlay] ***********************************************************************************************************************************************************************************************
ok: [198.18.4.101]
ok: [198.18.4.104]
ok: [198.18.4.103]

TASK [debug] *********************************************************************************************************************************************************************************************************
ok: [198.18.4.101] =&gt; {
    &quot;underlay_output.stdout_lines&quot;: [
        [
            &quot;OSPF Process ID 1 VRF default&quot;,
            &quot; Total number of neighbors: 2&quot;,
            &quot; Neighbor ID     Pri State            Up Time  Address         Interface&quot;,
            &quot; 192.168.0.6       1 FULL/ -          01:27:12 10.0.0.21       Eth1/1 &quot;,
            &quot; 192.168.0.7       1 FULL/ -          01:27:12 10.0.128.5      Eth1/2&quot;
        ],
        [
            &quot;BGP summary information for VRF default, address family IPv4 Unicast&quot;,
            &quot;BGP router identifier 192.168.0.8, local AS number 65000&quot;,
            &quot;BGP table version is 6, IPv4 Unicast config peers 2, capable peers 2&quot;,
            &quot;0 network entries and 0 paths using 0 bytes of memory&quot;,
            &quot;BGP attribute entries [0/0], BGP AS path entries [0/0]&quot;,
            &quot;BGP community entries [0/0], BGP clusterlist entries [4/16]&quot;,
            &quot;&quot;,
            &quot;Neighbor        V    AS MsgRcvd MsgSent   TblVer  InQ OutQ Up/Down  State/PfxRcd&quot;,
            &quot;192.168.0.6     4 65000     161     106        6    0    0 01:23:17 0         &quot;,
            &quot;192.168.0.7     4 65000     161     106        6    0    0 01:23:15 0&quot;
        ],
        [
            &quot;PIM Neighbor Status for VRF \&quot;default\&quot;&quot;,
            &quot;Neighbor        Interface            Uptime    Expires   DR       Bidir-  BFD    ECMP Redirect&quot;,
            &quot;                                                         Priority Capable State     Capable&quot;,
            &quot;10.0.0.21       Ethernet1/1          01:23:08  00:01:35  1        yes     n/a     no&quot;,
            &quot;10.0.128.5      Ethernet1/2          01:23:07  00:01:31  1        yes     n/a     no&quot;
        ]
    ]
}
ok: [198.18.4.104] =&gt; {
    &quot;underlay_output.stdout_lines&quot;: [
        [
            &quot;OSPF Process ID 1 VRF default&quot;,
            &quot; Total number of neighbors: 2&quot;,
            &quot; Neighbor ID     Pri State            Up Time  Address         Interface&quot;,
            &quot; 192.168.0.6       1 FULL/ -          1d04h    10.0.128.1      Eth1/1 &quot;,
            &quot; 192.168.0.7       1 FULL/ -          1d04h    10.0.128.17     Eth1/2&quot;
        ],
        [
            &quot;BGP summary information for VRF default, address family IPv4 Unicast&quot;,
            &quot;BGP router identifier 192.168.0.11, local AS number 65000&quot;,
            &quot;BGP table version is 5, IPv4 Unicast config peers 2, capable peers 2&quot;,
            &quot;0 network entries and 0 paths using 0 bytes of memory&quot;,
            &quot;BGP attribute entries [0/0], BGP AS path entries [0/0]&quot;,
            &quot;BGP community entries [0/0], BGP clusterlist entries [4/16]&quot;,
            &quot;&quot;,
            &quot;Neighbor        V    AS MsgRcvd MsgSent   TblVer  InQ OutQ Up/Down  State/PfxRcd&quot;,
            &quot;192.168.0.6     4 65000     672     662        5    0    0 07:03:12 0         &quot;,
            &quot;192.168.0.7     4 65000    1441    1433        5    0    0 22:36:01 0&quot;
        ],
        [
            &quot;PIM Neighbor Status for VRF \&quot;default\&quot;&quot;,
            &quot;Neighbor        Interface            Uptime    Expires   DR       Bidir-  BFD    ECMP Redirect&quot;,
            &quot;                                                         Priority Capable State     Capable&quot;,
            &quot;10.0.128.1      Ethernet1/1          08:51:43  00:01:28  1        yes     n/a     no&quot;,
            &quot;10.0.128.17     Ethernet1/2          22:36:23  00:01:23  1        yes     n/a     no&quot;
        ]
    ]
}
ok: [198.18.4.103] =&gt; {
    &quot;underlay_output.stdout_lines&quot;: [
        [
            &quot;OSPF Process ID 1 VRF default&quot;,
            &quot; Total number of neighbors: 2&quot;,
            &quot; Neighbor ID     Pri State            Up Time  Address         Interface&quot;,
            &quot; 192.168.0.6       1 FULL/ -          01:27:11 10.0.0.29       Eth1/1 &quot;,
            &quot; 192.168.0.7       1 FULL/ -          01:27:10 10.0.128.13     Eth1/2&quot;
        ],
        [
            &quot;BGP summary information for VRF default, address family IPv4 Unicast&quot;,
            &quot;BGP router identifier 192.168.0.10, local AS number 65000&quot;,
            &quot;BGP table version is 6, IPv4 Unicast config peers 2, capable peers 2&quot;,
            &quot;0 network entries and 0 paths using 0 bytes of memory&quot;,
            &quot;BGP attribute entries [0/0], BGP AS path entries [0/0]&quot;,
            &quot;BGP community entries [0/0], BGP clusterlist entries [4/16]&quot;,
            &quot;&quot;,
            &quot;Neighbor        V    AS MsgRcvd MsgSent   TblVer  InQ OutQ Up/Down  State/PfxRcd&quot;,
            &quot;192.168.0.6     4 65000     148     107        6    0    0 01:23:17 0         &quot;,
            &quot;192.168.0.7     4 65000     150     107        6    0    0 01:23:17 0&quot;
        ],
        [
            &quot;PIM Neighbor Status for VRF \&quot;default\&quot;&quot;,
            &quot;Neighbor        Interface            Uptime    Expires   DR       Bidir-  BFD    ECMP Redirect&quot;,
            &quot;                                                         Priority Capable State     Capable&quot;,
            &quot;10.0.0.29       Ethernet1/1          01:23:09  00:01:37  1        yes     n/a     no&quot;,
            &quot;10.0.128.13     Ethernet1/2          01:23:08  00:01:23  1        yes     n/a     no&quot;
        ]
    ]
}

PLAY RECAP ***********************************************************************************************************************************************************************************************************
198.18.4.101               : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
198.18.4.103               : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
198.18.4.104               : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0

</code></pre>
<p><strong>Next:</strong></p>
<ul>
<li>On the <strong>Ansible</strong> node (via <strong>MTPutty</strong>), execute the <strong>verify_fabric.yml</strong> playbook by issuing below command.  As per below, this command uses the <code>--tags</code> in the syntax to execute the respective tasks (as per the tag) in the playbook.  As per the output, <strong>verify</strong> the <strong>overlay</strong> outputs (as shown below).  <em>Note:</em> This command will show the nve tunnel peer, host route in BGP EVPN from all leaf switches:</li>
</ul>
<pre><code>ansible-playbook verify_fabric.yml --tags &quot;overlay&quot;
</code></pre>
<ul>
<li>
<p>Below screenshot of the partial output of above command:</p>
<p><img alt="" src="../pic/5-2-2.png" /></p>
</li>
<li>
<p>Below shows the complete log output of execution of above playbook command.   Verify the output for <strong>vne vni</strong> status, <strong>vne</strong> dynamic neighbors, mac-ip evpn route update for each L2VNI, l2fib etc. information:</p>
</li>
</ul>
<pre><code>root@ubuntu:~/EVPN-Ansible# ansible-playbook verify_fabric.yml --tags &quot;overlay&quot;

PLAY [leaf, jinja2_leaf] *********************************************************************************************************************************************************************************************

TASK [Verify Overlay] ************************************************************************************************************************************************************************************************
ok: [198.18.4.104]
ok: [198.18.4.103]
ok: [198.18.4.101]

TASK [debug] *********************************************************************************************************************************************************************************************************
ok: [198.18.4.104] =&gt; {
    &quot;overlay_output.stdout_lines&quot;: [
        [
            &quot;Codes: CP - Control Plane        DP - Data Plane          &quot;,
            &quot;       UC - Unconfigured         SA - Suppress ARP        &quot;,
            &quot;       SU - Suppress Unknown Unicast&quot;,
            &quot; &quot;,
            &quot;Interface VNI      Multicast-group   State Mode Type [BD/VRF]      Flags&quot;,
            &quot;--------- -------- ----------------- ----- ---- ------------------ -----&quot;,
            &quot;nve1      50140    239.0.0.140       Up    CP   L2 [140]                  &quot;,
            &quot;nve1      50141    239.0.0.141       Up    CP   L2 [141]                  &quot;,
            &quot;nve1      50999    n/a               Up    CP   L3 [Tenant-1]&quot;
        ],
        [
            &quot;Interface Peer-IP          State LearnType Uptime   Router-Mac       &quot;,
            &quot;--------- ---------------  ----- --------- -------- -----------------&quot;,
            &quot;nve1      192.168.0.18     Up    CP        01:07:55 000c.2997.621c   &quot;,
            &quot;nve1      192.168.0.110    Up    CP        01:23:17 000c.2939.f53f&quot;
        ],
        [
            &quot;IP Route Table for VRF \&quot;Tenant-1\&quot;&quot;,
            &quot;'*' denotes best ucast next-hop&quot;,
            &quot;'**' denotes best mcast next-hop&quot;,
            &quot;'[x/y]' denotes [preference/metric]&quot;,
            &quot;'%&lt;string&gt;' in via output denotes VRF &lt;string&gt;&quot;,
            &quot;&quot;,
            &quot;172.21.140.0/24, ubest/mbest: 1/0, attached&quot;,
            &quot;    *via 172.21.140.1, Vlan140, [0/0], 22:39:01, direct&quot;,
            &quot;172.21.140.1/32, ubest/mbest: 1/0, attached&quot;,
            &quot;    *via 172.21.140.1, Vlan140, [0/0], 22:39:01, local&quot;,
            &quot;172.21.140.10/32, ubest/mbest: 1/0&quot;,
            &quot;    *via 192.168.0.18%default, [200/0], 01:07:52, bgp-65000, internal, tag 65000 (evpn) segid: 50999 tunnelid: 0xc0a80012 encap: VXLAN&quot;,
            &quot; &quot;,
            &quot;172.21.140.11/32, ubest/mbest: 1/0&quot;,
            &quot;    *via 192.168.0.110%default, [200/0], 01:23:18, bgp-65000, internal, tag 65000 (evpn) segid: 50999 tunnelid: 0xc0a8006e encap: VXLAN&quot;,
            &quot; &quot;,
            &quot;172.21.141.0/24, ubest/mbest: 1/0, attached&quot;,
            &quot;    *via 172.21.141.1, Vlan141, [0/0], 22:38:59, direct&quot;,
            &quot;172.21.141.1/32, ubest/mbest: 1/0, attached&quot;,
            &quot;    *via 172.21.141.1, Vlan141, [0/0], 22:38:59, local&quot;,
            &quot;172.21.141.11/32, ubest/mbest: 1/0, attached&quot;,
            &quot;    *via 172.21.141.11, Vlan141, [190/0], 07:04:08, hmm&quot;
        ],
        [
            &quot;BGP routing table information for VRF default, address family L2VPN EVPN&quot;,
            &quot;BGP table version is 458, Local Router ID is 192.168.0.11&quot;,
            &quot;Status: s-suppressed, x-deleted, S-stale, d-dampened, h-history, *-valid, &gt;-best&quot;,
            &quot;Path type: i-internal, e-external, c-confed, l-local, a-aggregate, r-redist, I-injected&quot;,
            &quot;Origin codes: i - IGP, e - EGP, ? - incomplete, | - multipath, &amp; - backup&quot;,
            &quot;&quot;,
            &quot;   Network            Next Hop            Metric     LocPrf     Weight Path&quot;,
            &quot;Route Distinguisher: 192.168.0.8:32907&quot;,
            &quot;*&gt;i[2]:[0]:[0]:[48]:[0050.56a0.7630]:[0]:[0.0.0.0]/216&quot;,
            &quot;                      192.168.0.18                      100          0 i&quot;,
            &quot;* i                   192.168.0.18                      100          0 i&quot;,
            &quot;*&gt;i[2]:[0]:[0]:[48]:[0050.56a0.7630]:[32]:[172.21.140.10]/272&quot;,
            &quot;                      192.168.0.18                      100          0 i&quot;,
            &quot;* i                   192.168.0.18                      100          0 i&quot;,
            &quot;&quot;,
            &quot;Route Distinguisher: 192.168.0.10:32907&quot;,
            &quot;* i[2]:[0]:[0]:[48]:[0050.56a0.b5d1]:[0]:[0.0.0.0]/216&quot;,
            &quot;                      192.168.0.110                     100          0 i&quot;,
            &quot;*&gt;i                   192.168.0.110                     100          0 i&quot;,
            &quot;*&gt;i[2]:[0]:[0]:[48]:[0050.56a0.b5d1]:[32]:[172.21.140.11]/272&quot;,
            &quot;                      192.168.0.110                     100          0 i&quot;,
            &quot;* i                   192.168.0.110                     100          0 i&quot;,
            &quot;&quot;,
            &quot;Route Distinguisher: 192.168.0.11:32907    (L2VNI 50140)&quot;,
            &quot;*&gt;i[2]:[0]:[0]:[48]:[0050.56a0.7630]:[0]:[0.0.0.0]/216&quot;,
            &quot;                      192.168.0.18                      100          0 i&quot;,
            &quot;*&gt;i[2]:[0]:[0]:[48]:[0050.56a0.b5d1]:[0]:[0.0.0.0]/216&quot;,
            &quot;                      192.168.0.110                     100          0 i&quot;,
            &quot;*&gt;i[2]:[0]:[0]:[48]:[0050.56a0.7630]:[32]:[172.21.140.10]/272&quot;,
            &quot;                      192.168.0.18                      100          0 i&quot;,
            &quot;*&gt;i[2]:[0]:[0]:[48]:[0050.56a0.b5d1]:[32]:[172.21.140.11]/272&quot;,
            &quot;                      192.168.0.110                     100          0 i&quot;,
            &quot;&quot;,
            &quot;Route Distinguisher: 192.168.0.11:32908    (L2VNI 50141)&quot;,
            &quot;*&gt;l[2]:[0]:[0]:[48]:[000c.2979.f00d]:[0]:[0.0.0.0]/216&quot;,
            &quot;                      192.168.0.111                     100      32768 i&quot;,
            &quot;*&gt;l[2]:[0]:[0]:[48]:[000c.2979.f00d]:[32]:[172.21.141.11]/272&quot;,
            &quot;                      192.168.0.111                     100      32768 i&quot;,
            &quot;&quot;,
            &quot;Route Distinguisher: 192.168.0.11:3    (L3VNI 50999)&quot;,
            &quot;*&gt;i[2]:[0]:[0]:[48]:[0050.56a0.7630]:[32]:[172.21.140.10]/272&quot;,
            &quot;                      192.168.0.18                      100          0 i&quot;,
            &quot;*&gt;i[2]:[0]:[0]:[48]:[0050.56a0.b5d1]:[32]:[172.21.140.11]/272&quot;,
            &quot;                      192.168.0.110                     100          0 i&quot;
        ],
        [
            &quot;Flags -(Rmac):Router MAC (Stt):Static (L):Local (R):Remote (V):vPC link &quot;,
            &quot;(Dup):Duplicate (Spl):Split (Rcv):Recv(D):Del Pending (S):Stale (C):Clear&quot;,
            &quot;(Ps):Peer Sync (Ro):Re-Originated &quot;,
            &quot;Topology    Mac Address    Prod   Flags         Seq No     Host IP         Next-Hops      &quot;,
            &quot;----------- -------------- ------ ---------- --------------- ---------------&quot;,
            &quot;140         0050.56a0.7630 BGP    --            0          172.21.140.10  192.168.0.18   &quot;,
            &quot;140         0050.56a0.b5d1 BGP    --            0          172.21.140.11  192.168.0.110  &quot;,
            &quot;141         000c.2979.f00d HMM    --            0          172.21.141.11  Local&quot;
        ]
    ]
}
ok: [198.18.4.103] =&gt; {
    &quot;overlay_output.stdout_lines&quot;: [
        [
            &quot;Codes: CP - Control Plane        DP - Data Plane          &quot;,
            &quot;       UC - Unconfigured         SA - Suppress ARP        &quot;,
            &quot;       SU - Suppress Unknown Unicast&quot;,
            &quot; &quot;,
            &quot;Interface VNI      Multicast-group   State Mode Type [BD/VRF]      Flags&quot;,
            &quot;--------- -------- ----------------- ----- ---- ------------------ -----&quot;,
            &quot;nve1      50140    239.0.0.140       Up    CP   L2 [140]                  &quot;,
            &quot;nve1      50141    239.0.0.141       Up    CP   L2 [141]                  &quot;,
            &quot;nve1      50999    n/a               Up    CP   L3 [Tenant-1]&quot;
        ],
        [
            &quot;Interface Peer-IP          State LearnType Uptime   Router-Mac       &quot;,
            &quot;--------- ---------------  ----- --------- -------- -----------------&quot;,
            &quot;nve1      192.168.0.18     Up    CP        01:07:55 000c.2997.621c   &quot;,
            &quot;nve1      192.168.0.111    Up    CP        01:23:20 000c.2951.176f&quot;
        ],
        [
            &quot;IP Route Table for VRF \&quot;Tenant-1\&quot;&quot;,
            &quot;'*' denotes best ucast next-hop&quot;,
            &quot;'**' denotes best mcast next-hop&quot;,
            &quot;'[x/y]' denotes [preference/metric]&quot;,
            &quot;'%&lt;string&gt;' in via output denotes VRF &lt;string&gt;&quot;,
            &quot;&quot;,
            &quot;172.21.140.0/24, ubest/mbest: 1/0, attached&quot;,
            &quot;    *via 172.21.140.1, Vlan140, [0/0], 01:24:28, direct&quot;,
            &quot;172.21.140.1/32, ubest/mbest: 1/0, attached&quot;,
            &quot;    *via 172.21.140.1, Vlan140, [0/0], 01:24:28, local&quot;,
            &quot;172.21.140.10/32, ubest/mbest: 1/0&quot;,
            &quot;    *via 192.168.0.18%default, [200/0], 01:07:53, bgp-65000, internal, tag 65000 (evpn) segid: 50999 tunnelid: 0xc0a80012 encap: VXLAN&quot;,
            &quot; &quot;,
            &quot;172.21.140.11/32, ubest/mbest: 1/0, attached&quot;,
            &quot;    *via 172.21.140.11, Vlan140, [190/0], 01:23:18, hmm&quot;,
            &quot;172.21.141.0/24, ubest/mbest: 1/0, attached&quot;,
            &quot;    *via 172.21.141.1, Vlan141, [0/0], 01:24:25, direct&quot;,
            &quot;172.21.141.1/32, ubest/mbest: 1/0, attached&quot;,
            &quot;    *via 172.21.141.1, Vlan141, [0/0], 01:24:25, local&quot;,
            &quot;172.21.141.11/32, ubest/mbest: 1/0&quot;,
            &quot;    *via 192.168.0.111%default, [200/0], 01:23:20, bgp-65000, internal, tag 65000 (evpn) segid: 50999 tunnelid: 0xc0a8006f encap: VXLAN&quot;
        ],
        [
            &quot;BGP routing table information for VRF default, address family L2VPN EVPN&quot;,
            &quot;BGP table version is 195, Local Router ID is 192.168.0.10&quot;,
            &quot;Status: s-suppressed, x-deleted, S-stale, d-dampened, h-history, *-valid, &gt;-best&quot;,
            &quot;Path type: i-internal, e-external, c-confed, l-local, a-aggregate, r-redist, I-injected&quot;,
            &quot;Origin codes: i - IGP, e - EGP, ? - incomplete, | - multipath, &amp; - backup&quot;,
            &quot;&quot;,
            &quot;   Network            Next Hop            Metric     LocPrf     Weight Path&quot;,
            &quot;Route Distinguisher: 192.168.0.8:32907&quot;,
            &quot;* i[2]:[0]:[0]:[48]:[0050.56a0.7630]:[0]:[0.0.0.0]/216&quot;,
            &quot;                      192.168.0.18                      100          0 i&quot;,
            &quot;*&gt;i                   192.168.0.18                      100          0 i&quot;,
            &quot;* i[2]:[0]:[0]:[48]:[0050.56a0.7630]:[32]:[172.21.140.10]/272&quot;,
            &quot;                      192.168.0.18                      100          0 i&quot;,
            &quot;*&gt;i                   192.168.0.18                      100          0 i&quot;,
            &quot;&quot;,
            &quot;Route Distinguisher: 192.168.0.10:32907    (L2VNI 50140)&quot;,
            &quot;*&gt;i[2]:[0]:[0]:[48]:[0050.56a0.7630]:[0]:[0.0.0.0]/216&quot;,
            &quot;                      192.168.0.18                      100          0 i&quot;,
            &quot;*&gt;l[2]:[0]:[0]:[48]:[0050.56a0.b5d1]:[0]:[0.0.0.0]/216&quot;,
            &quot;                      192.168.0.110                     100      32768 i&quot;,
            &quot;*&gt;i[2]:[0]:[0]:[48]:[0050.56a0.7630]:[32]:[172.21.140.10]/272&quot;,
            &quot;                      192.168.0.18                      100          0 i&quot;,
            &quot;*&gt;l[2]:[0]:[0]:[48]:[0050.56a0.b5d1]:[32]:[172.21.140.11]/272&quot;,
            &quot;                      192.168.0.110                     100      32768 i&quot;,
            &quot;&quot;,
            &quot;Route Distinguisher: 192.168.0.10:32908    (L2VNI 50141)&quot;,
            &quot;*&gt;i[2]:[0]:[0]:[48]:[000c.2979.f00d]:[0]:[0.0.0.0]/216&quot;,
            &quot;                      192.168.0.111                     100          0 i&quot;,
            &quot;*&gt;i[2]:[0]:[0]:[48]:[000c.2979.f00d]:[32]:[172.21.141.11]/272&quot;,
            &quot;                      192.168.0.111                     100          0 i&quot;,
            &quot;&quot;,
            &quot;Route Distinguisher: 192.168.0.11:32908&quot;,
            &quot;* i[2]:[0]:[0]:[48]:[000c.2979.f00d]:[0]:[0.0.0.0]/216&quot;,
            &quot;                      192.168.0.111                     100          0 i&quot;,
            &quot;*&gt;i                   192.168.0.111                     100          0 i&quot;,
            &quot;* i[2]:[0]:[0]:[48]:[000c.2979.f00d]:[32]:[172.21.141.11]/272&quot;,
            &quot;                      192.168.0.111                     100          0 i&quot;,
            &quot;*&gt;i                   192.168.0.111                     100          0 i&quot;,
            &quot;&quot;,
            &quot;Route Distinguisher: 192.168.0.10:3    (L3VNI 50999)&quot;,
            &quot;*&gt;i[2]:[0]:[0]:[48]:[000c.2979.f00d]:[32]:[172.21.141.11]/272&quot;,
            &quot;                      192.168.0.111                     100          0 i&quot;,
            &quot;*&gt;i[2]:[0]:[0]:[48]:[0050.56a0.7630]:[32]:[172.21.140.10]/272&quot;,
            &quot;                      192.168.0.18                      100          0 i&quot;
        ],
        [
            &quot;Flags -(Rmac):Router MAC (Stt):Static (L):Local (R):Remote (V):vPC link &quot;,
            &quot;(Dup):Duplicate (Spl):Split (Rcv):Recv(D):Del Pending (S):Stale (C):Clear&quot;,
            &quot;(Ps):Peer Sync (Ro):Re-Originated &quot;,
            &quot;Topology    Mac Address    Prod   Flags         Seq No     Host IP         Next-Hops      &quot;,
            &quot;----------- -------------- ------ ---------- --------------- ---------------&quot;,
            &quot;140         0050.56a0.7630 BGP    --            0          172.21.140.10  192.168.0.18   &quot;,
            &quot;140         0050.56a0.b5d1 HMM    --            0          172.21.140.11  Local          &quot;,
            &quot;141         000c.2979.f00d BGP    --            0          172.21.141.11  192.168.0.111&quot;
        ]
    ]
}
ok: [198.18.4.101] =&gt; {
    &quot;overlay_output.stdout_lines&quot;: [
        [
            &quot;Codes: CP - Control Plane        DP - Data Plane          &quot;,
            &quot;       UC - Unconfigured         SA - Suppress ARP        &quot;,
            &quot;       SU - Suppress Unknown Unicast&quot;,
            &quot; &quot;,
            &quot;Interface VNI      Multicast-group   State Mode Type [BD/VRF]      Flags&quot;,
            &quot;--------- -------- ----------------- ----- ---- ------------------ -----&quot;,
            &quot;nve1      50140    239.0.0.140       Up    CP   L2 [140]                  &quot;,
            &quot;nve1      50141    239.0.0.141       Up    CP   L2 [141]                  &quot;,
            &quot;nve1      50999    n/a               Up    CP   L3 [Tenant-1]&quot;
        ],
        [
            &quot;Interface Peer-IP          State LearnType Uptime   Router-Mac       &quot;,
            &quot;--------- ---------------  ----- --------- -------- -----------------&quot;,
            &quot;nve1      192.168.0.110    Up    CP        01:07:59 000c.2939.f53f   &quot;,
            &quot;nve1      192.168.0.111    Up    CP        01:07:59 000c.2951.176f&quot;
        ],
        [
            &quot;IP Route Table for VRF \&quot;Tenant-1\&quot;&quot;,
            &quot;'*' denotes best ucast next-hop&quot;,
            &quot;'**' denotes best mcast next-hop&quot;,
            &quot;'[x/y]' denotes [preference/metric]&quot;,
            &quot;'%&lt;string&gt;' in via output denotes VRF &lt;string&gt;&quot;,
            &quot;&quot;,
            &quot;172.21.140.0/24, ubest/mbest: 1/0, attached&quot;,
            &quot;    *via 172.21.140.1, Vlan140, [0/0], 01:24:29, direct&quot;,
            &quot;172.21.140.1/32, ubest/mbest: 1/0, attached&quot;,
            &quot;    *via 172.21.140.1, Vlan140, [0/0], 01:24:29, local&quot;,
            &quot;172.21.140.10/32, ubest/mbest: 1/0, attached&quot;,
            &quot;    *via 172.21.140.10, Vlan140, [190/0], 01:24:18, hmm&quot;,
            &quot;172.21.140.11/32, ubest/mbest: 1/0&quot;,
            &quot;    *via 192.168.0.110%default, [200/0], 01:07:51, bgp-65000, internal, tag 65000 (evpn) segid: 50999 tunnelid: 0xc0a8006e encap: VXLAN&quot;,
            &quot; &quot;,
            &quot;172.21.141.0/24, ubest/mbest: 1/0, attached&quot;,
            &quot;    *via 172.21.141.1, Vlan141, [0/0], 01:24:25, direct&quot;,
            &quot;172.21.141.1/32, ubest/mbest: 1/0, attached&quot;,
            &quot;    *via 172.21.141.1, Vlan141, [0/0], 01:24:25, local&quot;,
            &quot;172.21.141.11/32, ubest/mbest: 1/0&quot;,
            &quot;    *via 192.168.0.111%default, [200/0], 01:07:51, bgp-65000, internal, tag 65000 (evpn) segid: 50999 tunnelid: 0xc0a8006f encap: VXLAN&quot;
        ],
        [
            &quot;BGP routing table information for VRF default, address family L2VPN EVPN&quot;,
            &quot;BGP table version is 210, Local Router ID is 192.168.0.8&quot;,
            &quot;Status: s-suppressed, x-deleted, S-stale, d-dampened, h-history, *-valid, &gt;-best&quot;,
            &quot;Path type: i-internal, e-external, c-confed, l-local, a-aggregate, r-redist, I-injected&quot;,
            &quot;Origin codes: i - IGP, e - EGP, ? - incomplete, | - multipath, &amp; - backup&quot;,
            &quot;&quot;,
            &quot;   Network            Next Hop            Metric     LocPrf     Weight Path&quot;,
            &quot;Route Distinguisher: 192.168.0.8:32907    (L2VNI 50140)&quot;,
            &quot;*&gt;l[2]:[0]:[0]:[48]:[0050.56a0.7630]:[0]:[0.0.0.0]/216&quot;,
            &quot;                      192.168.0.18                      100      32768 i&quot;,
            &quot;*&gt;i[2]:[0]:[0]:[48]:[0050.56a0.b5d1]:[0]:[0.0.0.0]/216&quot;,
            &quot;                      192.168.0.110                     100          0 i&quot;,
            &quot;*&gt;l[2]:[0]:[0]:[48]:[0050.56a0.7630]:[32]:[172.21.140.10]/272&quot;,
            &quot;                      192.168.0.18                      100      32768 i&quot;,
            &quot;*&gt;i[2]:[0]:[0]:[48]:[0050.56a0.b5d1]:[32]:[172.21.140.11]/272&quot;,
            &quot;                      192.168.0.110                     100          0 i&quot;,
            &quot;&quot;,
            &quot;Route Distinguisher: 192.168.0.8:32908    (L2VNI 50141)&quot;,
            &quot;*&gt;i[2]:[0]:[0]:[48]:[000c.2979.f00d]:[0]:[0.0.0.0]/216&quot;,
            &quot;                      192.168.0.111                     100          0 i&quot;,
            &quot;*&gt;i[2]:[0]:[0]:[48]:[000c.2979.f00d]:[32]:[172.21.141.11]/272&quot;,
            &quot;                      192.168.0.111                     100          0 i&quot;,
            &quot;&quot;,
            &quot;Route Distinguisher: 192.168.0.10:32907&quot;,
            &quot;* i[2]:[0]:[0]:[48]:[0050.56a0.b5d1]:[0]:[0.0.0.0]/216&quot;,
            &quot;                      192.168.0.110                     100          0 i&quot;,
            &quot;*&gt;i                   192.168.0.110                     100          0 i&quot;,
            &quot;* i[2]:[0]:[0]:[48]:[0050.56a0.b5d1]:[32]:[172.21.140.11]/272&quot;,
            &quot;                      192.168.0.110                     100          0 i&quot;,
            &quot;*&gt;i                   192.168.0.110                     100          0 i&quot;,
            &quot;&quot;,
            &quot;Route Distinguisher: 192.168.0.11:32908&quot;,
            &quot;*&gt;i[2]:[0]:[0]:[48]:[000c.2979.f00d]:[0]:[0.0.0.0]/216&quot;,
            &quot;                      192.168.0.111                     100          0 i&quot;,
            &quot;* i                   192.168.0.111                     100          0 i&quot;,
            &quot;* i[2]:[0]:[0]:[48]:[000c.2979.f00d]:[32]:[172.21.141.11]/272&quot;,
            &quot;                      192.168.0.111                     100          0 i&quot;,
            &quot;*&gt;i                   192.168.0.111                     100          0 i&quot;,
            &quot;&quot;,
            &quot;Route Distinguisher: 192.168.0.8:3    (L3VNI 50999)&quot;,
            &quot;*&gt;i[2]:[0]:[0]:[48]:[000c.2979.f00d]:[32]:[172.21.141.11]/272&quot;,
            &quot;                      192.168.0.111                     100          0 i&quot;,
            &quot;*&gt;i[2]:[0]:[0]:[48]:[0050.56a0.b5d1]:[32]:[172.21.140.11]/272&quot;,
            &quot;                      192.168.0.110                     100          0 i&quot;
        ],
        [
            &quot;Flags -(Rmac):Router MAC (Stt):Static (L):Local (R):Remote (V):vPC link &quot;,
            &quot;(Dup):Duplicate (Spl):Split (Rcv):Recv(D):Del Pending (S):Stale (C):Clear&quot;,
            &quot;(Ps):Peer Sync (Ro):Re-Originated &quot;,
            &quot;Topology    Mac Address    Prod   Flags         Seq No     Host IP         Next-Hops      &quot;,
            &quot;----------- -------------- ------ ---------- --------------- ---------------&quot;,
            &quot;140         0050.56a0.7630 HMM    --            0          172.21.140.10  Local          &quot;,
            &quot;140         0050.56a0.b5d1 BGP    --            0          172.21.140.11  192.168.0.110  &quot;,
            &quot;141         000c.2979.f00d BGP    --            0          172.21.141.11  192.168.0.111&quot;
        ]
    ]
}

PLAY RECAP ***********************************************************************************************************************************************************************************************************
198.18.4.101               : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
198.18.4.103               : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
198.18.4.104               : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0

root@ubuntu:~/EVPN-Ansible#
</code></pre>
<hr />
<h3 id="step-2-install-git-and-gitlab-runner">Step 2: Install git and GitLab runner</h3>
<p>In this section you will install git and gitlab runner on Anisble node.</p>
<ul>
<li>On the <strong>Ansible node</strong> (in <strong>MTPuTTy</strong> SSH session), run the below package installation command to install git:</li>
</ul>
<pre><code>cd ~/EVPN-Ansible
apt-get install git
</code></pre>
<p>Below screenshot shows the execution of the command</p>
<p><img alt="" src="../pic/5-3-1.png" /></p>
<ul>
<li>On the <strong>Ansible node</strong> (in <strong>MTPuTTy</strong> SSH session), run the below <code>curl</code> command to download and run a shell script that adds the official GitLab repository required for runner installation:</li>
</ul>
<pre><code>curl -L https://packages.gitlab.com/install/repositories/runner/gitlab-runner/script.deb.sh | sudo bash

</code></pre>
<p>Below screenshot shows the execution of the command</p>
<p><img alt="" src="../pic/5-3-2.png" /></p>
<ul>
<li>On the <strong>Ansible node</strong> (in <strong>MTPuTTy</strong> SSH session), run the below command to install <code>gitlab-runner</code></li>
</ul>
<pre><code>apt-get install gitlab-runner
</code></pre>
<p>Below screenshot shows the output of above command:</p>
<p><img alt="" src="../pic/5-3-3.png" /></p>
<p>!!! Note
    You may see installation of newer version of gitlab-runner.</p>
<h3 id="step-3-gitlab-repository-setup">Step 3: GitLab repository setup</h3>
<p>In this step, you will use setup repository for your respective Pod on Gitlab (SaaS) and then push your code (Ansible files) to this repository.  This basically uses Version Control System (VCS) capabilities on GitLab.  In addition, some GitLab settings will be modified to allow access rights to the repository.</p>
<ul>
<li>
<p>Open chrome browser and enter <strong><a href="https://gitlab.com/users/sign_in">gitlab.com/users/sign_in</a></strong> in the address bar. Sign in with <strong>Username:</strong> <code>lab.ciscolive@gmail.com</code> <strong>Password:</strong> <code>C1sco12345</code> as shown below.</p>
<p><img alt="" src="../pic/5-2-3.png" /></p>
</li>
<li>
<p>After signing to <strong><code>lab.ciscolive</code></strong> gitlab account, You may see a main page without any existing projects - this is shown in below screenshot.  To create a new project click on <strong>Create a project</strong> icon on this main page (shown below).  </p>
</li>
</ul>
<p>!!! Note
    After signing in to gitlab account you may see list of Projects (such as <code>POD_{ID}</code>).  The reason is that a single GitLab account (lab.ciscolive) is shared among all the attendees/pods.  Hence after logging into GitLab, you may also see projects already created by others in this lab.  If this is the case, click on <strong>New Project</strong> button on the right pane.  And you will see <code>Create new Project</code> page. </p>
<p><img alt="" src="../pic/5-2-4.png" /></p>
<ul>
<li>
<p>On the next page, click on <strong>Create a blank project</strong>.  </p>
</li>
<li>
<p>On the next page, enter <strong>Project name</strong> of your assigned as <strong><code>POD_{ID}</code></strong>.  Note: In the below screenshot of this page:</p>
<ul>
<li>You must replace the <code>{ID}</code> with your respective pod number.  Find your assigned <strong>POD_ID</strong> from table in <a href="https://ciscolivelab.github.io/LTRDCN-2765/task1-VPN/#step-1-connect-to-lab-using-anyconnect-vpn">Task1</a></li>
<li><code>Project slug</code> is automatically populated</li>
<li>Leave the default setting of <code>Visibility Level</code> to <code>Private</code></li>
<li>Leave the default setting of <code>Initialize repository with a README</code> with <code>checkbox</code> selected to automatically add <code>README</code> file in git repository</li>
</ul>
</li>
</ul>
<p>!!! Note
    You must replace <code>{ID}</code> with your respective pod number.  <strong>Project name</strong> of <strong><code>POD_1</code></strong> is shown as an example only.</p>
<p>Below screenshot shows execution of above for Pod_1 as a reference only:</p>
<p><img alt="" src="../pic/5-2-5.png" /></p>
<ul>
<li>Then click <strong>Create project</strong>  at the bottom of this <code>Create a blank project</code> page. </li>
</ul>
<p>A new project for your respective Pod is now created on GitLab.</p>
<ul>
<li>On the project page, copy the project url by clicking on <strong>Clone</strong> button, and then click <code>Copy URL</code> icon next to <strong>Clone with HTTPS</strong> as shown below in below screenshot.  This project url will be used in next step. The project url looks like <strong>https://gitlab.com/lab.ciscolive/pod_{ID}.git</strong>.</li>
</ul>
<p>!!! Note
    You must replace <code>{ID}</code> with your respective pod number.  </p>
<p>The screenshot below uses <strong>POD_1</strong> as example.</p>
<p><img alt="" src="../pic/5-2-6.png" /></p>
<p>By default the <strong>main</strong> branch is protected branch.  In order to add and commit files from git command, the branch settings need to be changed to unprotected.  This change of <strong>main</strong> branch to unprotected is performed as per below steps and shown in below screenshot:</p>
<ul>
<li>Navigate on left sidebar (pane) and Select <strong>Settings &gt; Repository</strong>.  </li>
<li>Then on right pane next to <strong>Protected branches</strong>, Click <strong>Expand</strong>. </li>
<li>Further, Click on <strong>Unprotect</strong> (in Red color) as shown in below screenshot.  Also, acknolwedge by clicking on <strong>Unprotect branch</strong> on the pop-up message.</li>
</ul>
<p><img alt="" src="../pic/5-2-7.png" /></p>
<p>Now the Git repository is setup properly for colloboration. And it can be used for keeping all the code i.e., Ansible playbooks and roles files.  Since all the code resides on local machine (Ansible node), so let's push this code to this newlly created centralized repository on GitLab.</p>
<ul>
<li>On the Ansible node (in <strong><em>MTputty</em></strong> SSH session), run the below commands to initialize git in appropriate directory:</li>
</ul>
<pre><code>cd ~/EVPN-Ansible
git init
</code></pre>
<p>Below screenshot shows the execution of the initialize commands in correct directory:</p>
<p><img alt="" src="../pic/5-3-5.png" /></p>
<ul>
<li>On the Ansible node, run following commands to add the remote repository (previously copied from <code>Clone with HTTPS</code> on GitLab) as origin for your respective <strong><code>Pod {ID}</code></strong> and verify it's result:</li>
</ul>
<pre><code>git remote add origin https://gitlab.com/lab.ciscolive/pod_{ID}.git
git remote -v
</code></pre>
<p>!!! Note
    You must replace <code>{ID}</code> with your respective pod number.  </p>
<p>Below screenshot shows the execution of the above commands for Pod_1 (as an example):</p>
<p><img alt="" src="../pic/5-3-5b.png" /></p>
<ul>
<li>Then to add all the files (Ansible playbooks, roles etc) to the staging area and check the status by using below commands:</li>
</ul>
<pre><code>git add .
git status
</code></pre>
<p>Below screenshot shows the execution of the above commands:</p>
<p><img alt="" src="../pic/5-3-5c.png" /></p>
<ul>
<li>Next, commit the files to local repository by executing below commands:</li>
</ul>
<pre><code>git checkout -b main
git commit -m &quot;initial commit&quot;
</code></pre>
<ul>
<li>Now, lets push all files to <strong>main</strong> branch on Gitlab repository (SaaS) with below commands.  When prompted for credentials, enter the <strong>Username:</strong> <code>lab.ciscolive</code> <strong>Password:</strong> <code>C1sco12345</code></li>
</ul>
<pre><code>git push -f origin main
</code></pre>
<p>Below screenshot shows output of the above command for pod_1 as an example:</p>
<p><img alt="" src="../pic/5-3-6.png" /></p>
<p>Now all your ansible code (playbooks, roles etc files) are pushed to your GitLab repository.  You can check the contents on web browser by going back to URL for your respective pod repository <strong><code>https://gitlab.com/lab.ciscolive/pod_{ID}</code></strong>.  You must replace {ID} with your respective pod number.</p>
<h3 id="step-4-add-cicd-pipeline-file">Step 4: Add CI/CD pipeline file</h3>
<p>Now that our repository and all the content is setup properly, we will create a pipeline file to perform specific actions (i.e., run Ansible playbook in our case).  Further, we will also define rules that will trigger (i.e., run) this pipeline based upon certain conditions.</p>
<p>In this step, you will create CI/CD pipeline file. Gitlab uses a special file named <strong><code>.gitlab-ci.yml</code></strong> for CI/CD configuration.  </p>
<p>!!! Note
    The filename starts with <strong><code>.</code></strong> and it's not a mistake.  </p>
<p>This file uses YAML syntax and needs to be placed in root directory of the repository.  In this file, you define your intent for the pipeline using a declarative syntax (in YAML) such as:</p>
<ul>
<li>The stages you want run in the pipeline</li>
<li>The scripts you want run in each stage</li>
<li>The runner you want use for each script</li>
<li>How is the runner triggered for each script</li>
</ul>
<p>Pipeline file can be added from GitLab UI using pipeline file editor, or create it locally and then push to GitLab repo using git commands.  We will use the latter option i.e., create this file locally and then push it GitLab repository.  We will use Atom to create this pipeline file.</p>
<ul>
<li>
<p>Switch to <strong>"Atom"</strong> application on your remote desktop.  Right click on the folder <strong>EVPN-Ansible</strong> and Click <strong>New File</strong> to create a new file named <strong>.gitlab-ci.yml</strong></p>
</li>
<li>
<p>In the <code>.gitlab-ci.yml</code> file enter the contents shown below:</p>
</li>
</ul>
<pre><code class="language-YAML">stages:
- test
- staging
- production

verify:
  stage: test
  tags:
    - EVPN
  script:
    - ansible-playbook jinja2_fabric.yml --check
  rules:
    - if: '$CI_PIPELINE_SOURCE == &quot;push&quot; &amp;&amp; $CI_COMMIT_BRANCH != &quot;main&quot;'
staging:
  stage: staging
  tags:
    - EVPN
  script:
    - ansible-playbook jinja2_fabric.yml
    - ansible-playbook nxos_fabric.yml
    - ansible-playbook verify_fabric.yml
  artifacts:
    paths:
      - overlay.txt
      - underlay.txt
  rules:
    - if: '$CI_PIPELINE_SOURCE == &quot;push&quot;  &amp;&amp; $CI_COMMIT_BRANCH != &quot;main&quot;'
deploy:
  stage: production
  tags:
    - EVPN
  script:
    - ansible-playbook jinja2_fabric.yml
    - ansible-playbook nxos_fabric.yml
  rules:
    - if: '$CI_PIPELINE_SOURCE == &quot;merge_request_event&quot;'
      when: manual
</code></pre>
<p>Below screenshot shows the file after adding the above contents on Atom:</p>
<p><img alt="" src="../pic/5-3-7.png" /></p>
<ul>
<li>From <strong>Atom</strong>, go to <strong>File &gt; Save</strong> to push the new pipeline to Ansible node</li>
</ul>
<p><strong>Note</strong>, in the above pipeline file, you have configured</p>
<ul>
<li>
<p>Three stages for pipeline named <strong>test</strong>, <strong>staging</strong> and <strong>production</strong></p>
</li>
<li>
<p>In <strong>test</strong> stage, pipeline will perform dry-run for the Ansible playbook using shell command (<code>ansible-playbook</code> with <code>--check</code> flag).  This is executed by using a git-runner with <code>tag</code> of <code>EVPN</code>.  Further, as per the <strong><code>rules</code></strong> setting, the script will be triggered by change in any <code>branch</code> other than <code>main</code>.</p>
</li>
<li>
<p>In <strong>staging</strong> stage, pipeline will run mutliple playbooks to add new VNIs on the BGP EVPN fabric.  For manual verification, this stage also collects the output of show commands in multiple files - these are referred to as <code>artifacts</code>.  Further, as per the <strong><code>rules</code></strong> setting, this scripts will be triggered after success of <code>test</code> stage and for any <code>branch</code> other than <code>main</code>.</p>
</li>
<li>
<p>In <strong>production</strong> stage, pipeline will run playbook to deploy EVPN fabric for new VNIs in production. Further, as per the <strong><code>rules</code></strong> setting, this script will be triggered after merge to main branch with manual trigger.</p>
</li>
</ul>
<p>Now lets push this file to GitLab centralized repository by execution of below steps:</p>
<ul>
<li>Switch to Ansible node (via <strong>MTPuTTY</strong>), add the <code>.gitlab-ci.yml</code> file to staging area, and then commit &amp; push the file to remote repository (on GitLab) as shown below.  When prompted for credentials, enter the <strong>Username:</strong> <code>lab.ciscolive</code> <strong>Password:</strong> <code>C1sco12345</code>for GitLab access:</li>
</ul>
<pre><code>git add .gitlab-ci.yml
git commit -m &quot;add ci file&quot;
git push origin main
</code></pre>
<p>Below screenshot shows the outputs of the commands for Pod_1 (note your git repository will be based upon your respective Pod_{ID}):</p>
<p><img alt="" src="../pic/5-3-8.png" /></p>
<h3 id="step-5-register-local-gitlab-runner">Step 5: Register local gitlab-runner</h3>
<p>We are ready to run our pipeline.  However the pipeline is run by a gitlab-runner.  And this runner needs to be registerted to GitLab (SaaS).  In this task, you will create local GitLab runner on Ansible server and then register it to your project on GitLab (SaaS) to run pipeline jobs. You will assign <strong>EVPN</strong> as tag of the runner as part of registration to your project on GitLab.</p>
<ul>
<li>Switch to Chrome brower with gitlab project page.  From the navigation menu on the left sidebar, Select <strong>Settings &gt; CI/CD</strong>.  Then on the right pane for the <strong><code>Runners</code></strong>, click on <strong>Expand</strong> setting as shown in below screenshot.</li>
</ul>
<p>!!! Note
    Screenshot below uses POD 1 as example, find your assigned POD ID from table in task1.</p>
<p><img alt="" src="../pic/5-5-1.png" /></p>
<ul>
<li>After expanding the <code>Runners</code> setting, under <code>Project runners</code> click on <strong>New project runner</strong>.  </li>
</ul>
<p><img alt="" src="../pic/5-5-1a.png" /></p>
<ul>
<li>On the next <code>New project runner</code> page, select <strong>Linux</strong> Operating systems under the <strong><code>Platform</code></strong>.  Further, enter a <strong><code>Tags</code></strong> value of <strong>EVPN</strong>, leave other settings as default, and click <strong>Submit</strong> on this page as shown in below screenshot:</li>
</ul>
<p><img alt="" src="../pic/5-5-1b.png" /></p>
<ul>
<li>On the next <strong><code>Register runner</code></strong> page, under <strong><code>Step 1</code></strong>, copy the <strong>runner token</strong> as part of the command line (<code>gitlab-runner register ...</code>) .  This token will be used later to register the gitlab runner that runs on Ansible server/node.  </li>
</ul>
<p>!!! Note
    Make sure to copy the runner token in this step.</p>
<ul>
<li>Then click on <strong>Go to runners page</strong> button.  If <code>Leave site?</code> prompt is displayed, then click <strong><code>Leave</code></strong> to proceed.</li>
</ul>
<p><img alt="" src="../pic/5-5-1c.png" /></p>
<ul>
<li>As shown in below screenshot, under <strong><code>Shared runners</code></strong>, click on the toggle switch named <strong>Enable shared runners for this project</strong> to disable the shared runners for this project.  Below screenshot shows the output once sharing has been disabled.</li>
</ul>
<p><img alt="" src="../pic/5-5-2.png" /></p>
<ul>
<li>
<p>Next switch to Ansible node (in <strong>MTputty</strong> SSH session) to register the GitLab runner by issuing the below command.  As part of this registration process, below settings are configured:</p>
<ul>
<li><code>GitLab URL</code> pointing to the GitLab running as SaaS. </li>
<li><code>Registration Token</code> for (authentication) of runner to Gitlab project.</li>
<li><code>Tags</code> - When a CI/CD job runs, it knows which runner to use by looking at the assigned tags.  It allows to filter a runner from a list of available runners for a job.  In this lab only a single runner is used.</li>
<li><code>Executor</code>: It determines the environment where the job runs in.  In this case Ansible playbooks are executed on a <code>shell</code> enviornment.</li>
</ul>
</li>
</ul>
<pre><code>gitlab-runner register
</code></pre>
<p>When prompted provide the runner registration info as shown below:</p>
<ul>
<li>
<p><strong><code>Enter the GitLab instance URL:</code></strong>  <strong>https://gitlab.com/</strong></p>
</li>
<li>
<p><strong><code>Enter the registration token:</code></strong>  Paste the <strong><code>runner token</code></strong> value generated and copied on GitHub (previous step)</p>
</li>
<li>
<p><strong><code>Enter a name for the runner:</code></strong> <strong>EVPN</strong></p>
</li>
<li>
<p><strong><code>Enter an executor:</code></strong> <strong>shell</strong></p>
</li>
</ul>
<p>After entering <code>shell</code>, wait few seconds for the registration of the runner.  Below screenshot shows the outputs of the commands:</p>
<p><img alt="" src="../pic/5-5-3.png" /></p>
<ul>
<li>On the Ansible node (in <strong>MTputty</strong> SSH session), run command the below commands to check status of runner:</li>
</ul>
<pre><code>gitlab-runner status
gitlab-runner list
</code></pre>
<p>Below screenshots shown the output of above commands</p>
<p><img alt="" src="../pic/5-5-4.png" /></p>
<h3 id="step-6-add-new-vnis-in-staging-and-trigger-pipeline">Step 6: Add new VNIs in Staging and trigger pipeline</h3>
<p>In this task, you will modify the variable files to add new networks on the EVPN fabric.  Instead of applying the changes (new VNIs) directly to <code>main</code> repository, you will create a new repository named <code>newvni</code> on gitlab to validate and test it on a staging environment.  Once the changes (new VNIs) are pushed to <code>newvni</code> branch on the GitLab repository, it will automatically trigger execution of scripts, by gitlab runner, as per configuration of pipleline file (.gitlab-ci.yml).  Keep in mind that we only have one physical environment i.e., same set of switches are used for both staging and production.</p>
<ul>
<li>Switch to <strong>"Atom"</strong>.  Under <strong>EVPN-Ansible</strong>, scroll to <strong>roles &gt; jinja2_leaf &gt; vars</strong> and open <strong>"main.yml"</strong> file.  Enter the new VNI details in this file below the existing <strong>L2VNI</strong> list as shown in the below screenshot:</li>
</ul>
<pre><code class="language-YAML">  - { vlan_id: 200, vni: 50200, ip_add: 172.21.200.1, mask: 24, vlan_name: L2-VNI-200-Tenant1, mcast: 239.0.0.200 }
  - { vlan_id: 201, vni: 50201, ip_add: 172.21.201.1, mask: 24, vlan_name: L2-VNI-201-Tenant1, mcast: 239.0.0.201 }  

</code></pre>
<p>!!! Note
    Do not completely replace existing content in this file.  Above content should be added to the end of existing L2VNI and above the existing L3VNI variables.</p>
<p>Below screenshot shows the file after addition of above contents on Atom:</p>
<p><img alt="" src="../pic/5-6-1.png" /></p>
<ul>
<li>
<p>From <strong>Atom</strong>, go to <strong>File &gt; Save</strong> to push the new variables to Ansible node.</p>
</li>
<li>
<p>Next, variables for Leaf role will be added.  From <strong>"Atom"</strong>, open <strong>"main.yml"</strong> file under <strong>roles &gt; leaf &gt; vars</strong>. Enter following new VNI informtion under <strong>L2VNI</strong> as shown in below screenshot:</p>
</li>
</ul>
<pre><code class="language-YAML">  - { vlan_id: 200, vni: 50200, ip_add: 172.21.200.1, mask: 24, vlan_name: L2-VNI-200-Tenant1, mcast: 239.0.0.200 }
  - { vlan_id: 201, vni: 50201, ip_add: 172.21.201.1, mask: 24, vlan_name: L2-VNI-201-Tenant1, mcast: 239.0.0.201 }
</code></pre>
<p>!!! Note
    Do not completely replace existing content in this file.  Above content should be added to the end of existing L2VNI and above the existing L3VNI variables.</p>
<p>Below screenshot shows the file after addition of above contents on Atom:</p>
<p><img alt="" src="../pic/5-6-2.png" /></p>
<ul>
<li>
<p>From <strong>Atom</strong>, go to <strong>File &gt; Save</strong> to push the new leaf variable file to Ansible node.</p>
</li>
<li>
<p>On the Ansible node (in <strong>MTputty</strong> SSH session), change directory to <strong>EVPN-Ansible</strong> project folder</p>
</li>
</ul>
<pre><code>cd ~/EVPN-Ansible
</code></pre>
<ul>
<li>Run the following git commands to create new branch <strong>newvni</strong>, <code>commit</code> the updated variable files to that new branch and <code>push</code> to Gitlab project:</li>
</ul>
<pre><code>git branch -m newvni
git add .
git commit -m &quot;newvni&quot;
git push -f origin newvni
</code></pre>
<p>When prompted, Use <strong>username:</strong> of <code>lab.ciscolive</code> and <strong>password:</strong> <code>C1sco12345</code> for gitlab access</p>
<p><img alt="" src="../pic/5-6-3.png" /></p>
<h3 id="step-7-review-pipeline-testing-and-staging-results">Step 7: Review pipeline testing and staging results</h3>
<p>In this task, you will review the script results from pipeline. The <strong>git push</strong> command in previous task triggered pipeline test and staging stage.</p>
<ul>
<li>Switch to Chrome brower with GitLab project page.  On the navigation menu on left side, select <strong>Build &gt; Pipelines</strong>  as shown below:</li>
</ul>
<p><img alt="" src="../pic/5-7-1.png" /></p>
<ul>
<li>Wait for the jobs finish, you can also access the runner console by clicking on any of the stage under <strong>Stages</strong> heading/column on this page and view the Job details as shown below:</li>
</ul>
<p><img alt="" src="../pic/5-7-2.png" /></p>
<ul>
<li>After both pipeline stages are passed, you can verify the result from the artifacts.  Click on the down arrow on the right most of the <code>pipeline</code> page and select <strong>Download artifacts</strong> to download the <code>staging:archive</code> as zip file.</li>
</ul>
<p><img alt="" src="../pic/5-7-3.png" /></p>
<ul>
<li>
<p>Unzip the downloaded <strong>artifacts.zip</strong> on your remote desktop, and you will see <strong>overlay.txt</strong> and <strong>underlay.txt</strong> files - these are the outputs from the ansible playbook.</p>
</li>
<li>
<p>Review the <code>overlay.txt</code> file and you can see new VNIs 50200 and 50201 deployed on staging environment as shown in partial output below:</p>
</li>
</ul>
<pre><code>-   - 'Codes: CP - Control Plane        DP - Data Plane          '
    - '       UC - Unconfigured         SA - Suppress ARP        '
    - '       SU - Suppress Unknown Unicast'
    - ' '
    - Interface VNI      Multicast-group   State Mode Type [BD/VRF]      Flags
    - '--------- -------- ----------------- ----- ---- ------------------ -----'
    - 'nve1      50140    239.0.0.140       Up    CP   L2 [140]                  '
    - 'nve1      50141    239.0.0.141       Up    CP   L2 [141]                  '
    - 'nve1      50200    239.0.0.200       Up    CP   L2 [200]                  '
    - 'nve1      50201    239.0.0.201       Up    CP   L2 [201]                  '
    - 'nve1      50203    239.0.0.203       Up    CP   L2 [203]                  '
    - 'nve1      50204    239.0.0.204       Up    CP   L2 [204]                  '
    - nve1      50999    n/a               Up    CP   L3 [Tenant-1]
-   - 'Interface Peer-IP          State LearnType Uptime   Router-Mac       '
    - '--------- ---------------  ----- --------- -------- -----------------'
    - nve1      192.168.0.18     Up    CP        1d15h    000c.2997.621c
-   - IP Route Table for VRF &quot;Tenant-1&quot;
    - '''*'' denotes best ucast next-hop'
    - '''**'' denotes best mcast next-hop'
    - '''[x/y]'' denotes [preference/metric]'
    - '''%&lt;string&gt;'' in via output denotes VRF &lt;string&gt;'
    - ''
    - '172.21.140.0/24, ubest/mbest: 1/0, attached'
    - '    *via 172.21.140.1, Vlan140, [0/0], 1d15h, direct'
    - '172.21.140.1/32, ubest/mbest: 1/0, attached'
    - '    *via 172.21.140.1, Vlan140, [0/0], 1d15h, local'
    - '172.21.140.10/32, ubest/mbest: 1/0'
    - '    *via 192.168.0.18%default, [200/0], 1d13h, bgp-65000, internal, tag 65000
        (evpn) segid: 50999 tunnelid: 0xc0a80012 encap: VXLAN'
    - ' '
    - '172.21.141.0/24, ubest/mbest: 1/0, attached'
    - '    *via 172.21.141.1, Vlan141, [0/0], 1d15h, direct'
    - '172.21.141.1/32, ubest/mbest: 1/0, attached'
    - '    *via 172.21.141.1, Vlan141, [0/0], 1d15h, local'
    - '172.21.200.0/24, ubest/mbest: 1/0, attached'
    - '    *via 172.21.200.1, Vlan200, [0/0], 1d15h, direct'
    - '172.21.200.1/32, ubest/mbest: 1/0, attached'
    - '    *via 172.21.200.1, Vlan200, [0/0], 1d15h, local'
    - '172.21.201.0/24, ubest/mbest: 1/0, attached'
    - '    *via 172.21.201.1, Vlan201, [0/0], 1d15h, direct'
    - '172.21.201.1/32, ubest/mbest: 1/0, attached'
    - '    *via 172.21.201.1, Vlan201, [0/0], 1d15h, local'
    - '172.21.203.0/24, ubest/mbest: 1/0, attached'
    - '    *via 172.21.203.1, Vlan203, [0/0], 1d13h, direct'
    - '172.21.203.1/32, ubest/mbest: 1/0, attached'
    - '    *via 172.21.203.1, Vlan203, [0/0], 1d13h, local'
    - '172.21.204.0/24, ubest/mbest: 1/0, attached'
    - '    *via 172.21.204.1, Vlan204, [0/0], 1d13h, direct'
    - '172.21.204.1/32, ubest/mbest: 1/0, attached'
    - '    *via 172.21.204.1, Vlan204, [0/0], 1d13h, local'

[output omitted]
</code></pre>
<h3 id="step-8-merge-code-to-main-branch">Step 8: Merge code to main branch</h3>
<p>After reviewing the test result from staging environment, you confirmed the new NVIs are deployed properly, you will merge the <strong>newvni</strong> branch to <strong>main</strong> branch and deploy the new VNIs on production environment.</p>
<p>Typically in real world there will (should!) be separate environments for staging and production.  In this lab, we are using same inventory for staging and production environments for simplicity purposes.  So once the merge is done then the changes can be rolled out to production (by applying ansible playbooks).</p>
<ul>
<li>Switch to Chrome browser with GitLab project page for your respective <code>Pod_{ID}</code> and then select <strong>Merge requests</strong> in the left sidebar.  Select <strong>New merge request</strong> on the right pane as shown in below screenshot.</li>
</ul>
<p><img alt="" src="../pic/5-8-1.png" /></p>
<ul>
<li>Under the <code>Source branch</code> section, from the <code>Select source branch</code> drop down menu select <strong>newvni</strong> branch.  </li>
<li>Further, on the <code>Target branch</code> section, under <code>Select target branch</code> drop down menu make sure that <strong>main</strong> branch is selected as shown in the screenshot below.</li>
</ul>
<p>!!! Note
    Below screenshot uses POD 1 as example, you must use <strong>your</strong> assigned <strong>POD ID</strong> from table in task1.</p>
<p><img alt="" src="../pic/5-8-2.png" /></p>
<ul>
<li>Then click <strong>Compare branches and continue</strong> on this page.</li>
</ul>
<p>Next, On the <strong>New merge request</strong> page (below screenshot):</p>
<ul>
<li>
<p>Enter the <strong><code>Title</code></strong> for the merge request as <strong>Newvni Pod_<code>#</code></strong> (replace <code>#</code> with your respective Pod ID),</p>
</li>
<li>
<p>And <strong>un-check</strong> the <strong>Delete source branch when merge request is accepted</strong>,</p>
</li>
<li>
<p>Then click the <strong>Create merge request</strong> button as shown in the screenshot below:</p>
</li>
</ul>
<p>!!! Note
    You must replace <code>{ID}</code> with your respective pod number.  <strong>Project name</strong> of <strong><code>POD_1</code></strong> in below screenshot is shown as an example only.</p>
<p><img alt="" src="../pic/5-8-3.png" /></p>
<p>On the next page (below screenshot), you are displayed with the details related to Merge: </p>
<ul>
<li>Review the details and then click on <strong>Merge</strong> button.   </li>
</ul>
<p><img alt="" src="../pic/5-8-3a.png" /></p>
<p>Wait for the <code>Merged by lab.ciscolive</code> message and for <code>Merge details</code> to appear on this page.</p>
<p><strong><em>So what is happening?</em></strong></p>
<p>After validating and testing deployment of VNIs in a branch named <code>newvni</code>, we have merged the new code (to deploy new VNIs) on the <code>main</code> branch.  However, the pipeline has not triggered.  Why?  Since, as per the CI/CD pipeline (filename: <strong>.gitlab-ci.yml</strong>) the <code>rules</code> setting was configured for <strong>manual</strong> trigger for production deployment.  This is just to demonstrate that, as per your environment, you may decide to be extra cautios and not deploy to production without additional review.  Hence the job for deploying production will not be triggered automatically.  Instead, you will manually kickoff the production deployment job on pipeline.  Let's proceed to initiate this manual trigger:</p>
<ul>
<li>
<p>Switch to Chrome brower with GitLab project page (your respective <code>Pod_{ID}</code>), select <strong>Build &gt; Pipelines</strong> from navigation menu on the left sidebar.</p>
</li>
<li>
<p>Deploy the changes to production enviroment by selecting on the <code>Play</code> <strong>button</strong> and then click on <strong>deploy</strong> as shown in the screenshot below:</p>
</li>
</ul>
<p><img alt="" src="../pic/5-8-4.png" /></p>
<ul>
<li>Wait for the job (all the Stages) to finish. You can also access the runner console output, to see execution of Ansible playbooks by clicking the pipeline stage named <code>deploy</code> under <strong>Stages</strong> on this page.  </li>
</ul>
<p>!!! Note
    <strong><code>POD_1</code></strong> in below screenshot is shown as an example only.  You must browse through to your own Pod #.</p>
<p>Below screenshot shows the successful execution of this deploy stage: </p>
<p><img alt="" src="../pic/5-8-5.png" /></p>
<h1 id="congratulation-you-have-completed-vxlan-fabric-and-netdevops-automation-lab">Congratulation! You have completed VXLAN Fabric and NetDevOps automation Lab.</h1>





                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var tab,labels=set.querySelector(".tabbed-labels");for(tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
            Back to top
          </button>
        
      </main>
      
        <footer class="md-footer">
  
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": ["navigation.tabs", "navigation.top", "navigation.instant", "navigation.indexes", "navigation.footer", "toc.follow", "content.tabs.link", "search.share", "search.highlight", "search.suggest", "content.code.copy", "content.code.annotations"], "search": "../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.51198bba.min.js"></script>
      
    
  </body>
</html>